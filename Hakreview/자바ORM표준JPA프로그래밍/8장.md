# 프록와 연관관계 정리 
프록시와 즉시로딩, 지연로딩 : 객체는 객체 그래프로 연관된 객체들을 탐색한. 그런데 객체가 데이터베이스에 저장되어 있으므로 연관된 객체를 마음 껏 탐색하기는 어렵다. 
JPA구현체들은 이 문제를 해결하려고 프록시라느 ㄴ기술을 사용한다. 프록시를 사용하면 연관된 객체를 처음부터 데이터베이스에서 조회하느 ㄴ것이 아니라 실제 사용하는 시점에 디비에서 조히할 수 있다. 하지만 자주 함께 사용하는 객체들은 조인을 사용해서 함께 조회하는것이 효과적이ㅏㄷ. 
JPA는 즉시로딩과 지연 로딩이라는 방법으로 둘을 모두 지원한다. 

영속성 전이, 고아객체 : JPA는 여관된 객체를 함께 저장하거나 함께 삭제할 수 있는 영속성 전이와 고아객체 제거라는 편리한 기능을 제공한다.
## 프록시
엔티티를 조회할 때, 연관된 엔티티들이 항상 사용되는것은 아니다. 예를 들어 회원 엔티티를 조회할때 연관된 팀 엔티티는 비즈니스 로직에 따라 사용되지 않을 수 있다. 
```
@Entity
public class Member {
        private String username;

        @ManyToOne 
        private Team team;

        public Team getTeam(){
                return team;
        }
        publid STring getUserName(){
            return username;
        }
}
```

```
@Entity
public class Team{
    private String name;

    public String getName(){
        return name;
    }
}
```

```
public void printUserNTeam(String memberId){
    Member m = em.find(Member.class, memberId);
    Team t = m.getTeam();

}
```

PA에서 식별자로 엔티티를 조회할때 EntityManager.find()를 사용한다. 이 메서드는 영속성컨텍스트의 1차캐시에 먼저 접근하고 데이터가 없으면 데이터베이스에 접근한다.

이렇게 엔티티를 직접 조회하면 죄회한 엔티티를 실제 사용하든 사용하지 않든 데이터베이스를 조회하게 된다. 엔티티를 실제 사용하는 시점까지 db조회를 미루고 싶으면 entitymanager.getReference90메서드를 사용하면 된다. 

이 메서드를 호출 할때 JPA는 db를 조회하지 않고 실제 엔티티 객체도 생성하지 않는다. 대신에 db접근을 위임한 프록시 객체를 반환한다. 

 

프록시 특징
프록시 클래스는 실제 클래스를 상송받아서 만들어지므로 실제 클래스와 모야이 같다. 사용하는 입장에서는 이것이 진짜 클래스객체인지 프록시 객체인지 구분할 수가 없다. 

 

// Proxy Obj
Proxy
---------------
Entity target
---------------
getId()
getName
---------------

//실제 Entity
Entity
---------------
id
name
---------------
getId()
getName()
proxy 객체는 실제 객체에 대한 target을 보관한다. 프록시 객체의 메서드를 호출하면 프록시 객체는 실제 객체의 메서드를 호출한다. 

프록시 객체는 .getName()처럼 getter,setter를 사용할때 데이터베이스를 조회해서 실제 엔티티 객체를 생성한다. 이것을 프록시 객체의 초기화라고 한다. 

 

프록시 객체는 실제 엔티티가 생성되어 있지 않으면 영속성 컨텍스트에 실제 엔티티 생성을 요청하는데 이것을 초기화라고 한다. 


 

프록시 특징

- 프록시 객체는 처음 사용할때 한번만 초기화 된다.

- 객체를 초기화한다고 프록시 객체가 실제 엔티티로 바뀌지 않는다. 

- 프록시 객체는 원본 엔티티를 상속받은 객체이므로 타입 체크 시에 주의해서 사용해야한다. 


- 관계형 DB는 상속관계 x

- 슈퍼타입 서브타입 관계라는 모델링 기법이 객체 상속과 유사

- 상속관계 매핑 : 객체의 상속과 구조와 DB의 슈퍼타입, 서브탕비 관계를 매핑


### 프록시와 컬렉션 래퍼 
지연로딩으로 설정하면 실제 엔티티 대신에 프록시 객체를 사ㅇ한다. 프ㄱ시 객체는 실제 자신이 사용될때까 데터베이스를 조히하지않는다.
하이버네이트는 엔티티를 영속 상태로 만들 때 엔티티에 컬렉션이 있으면 컬렉션을 추적하고 관ㅣ할 목적으로 원본 컬렉션을 하이버네이트가 제공하는 내장컬렉션으로 변경하는데 이ㅅ을 컬렉션 래펴라 한다.
엔티티를 지ㄴ로딩하면 프ㄱ시 객체를 사용해서 지연 로딩을 수ㅇ하지만 주문내역같은 컬렉션은 컬ㅔ션 래퍼가 지여로딩을 처리해준다. 컬ㅔ션 래퍼도 컬렉션에 대한  프ㄱ시 역ㅏㄹ을 하므로 따 구ㄴ하지않고 프록시라 부르겠다. 



